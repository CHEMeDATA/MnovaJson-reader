<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
  <h4>Mnova json demonstration page</h4>
  <p>This page reads the json serialization of Mnova document and uses JSmol and CHEMeDATA viewers for their
    visualization.</p>
  <style>
    .code-box {
      background: #f4f4f4;
      padding: 10px;
      font-family: monospace;
    }
  </style>

  <script type="text/javascript" src="src/JSmol.min.js"></script>
  <p id="textMainPage" style="height:20px">J-graph output</p>
  <script>
    compoundStructure = {
      script: "set antialiasDisplay true;load ../data/santonin/santonin.mol;cartoon on;color cartoon structure; rotate z 45.0;rotate x 80;",
      width: 350,
      height: 200,
      j2sPath: "src/j2s",
      disableJ2SLoadMonitor: false,
      isableInitialConsole: true
    }
    Jmol.getApplet("JmolAppletAz", compoundStructure);
  </script>
  <div id="my_dataviz"></div>
  <script type="module">

    import { processData } from "../src/mnovaReader.js";
    import { makeGraphic } from "../src/nmrSpectrum.js";

    var fName1 = "../data/santonin/santonin_spectrum.json";
    var fNameN = "../data/santonin/santonin_molecule.json"
    fNameN = "../data/santonin/santonin_moleculeWithAssignment.json"; // with partial assignment of J's

    // import { jGraph } from "../src/mnovaReader.js";
    //    var ajgraph = jGraph(fName1, fNameN, JmolAppletAz, "my_dataviz")
    /*
        const {
          jGraphObjDataList,
          allObjectsExtractedMolecule,
          spectrumDataAllChopped,
          regionsData,
        } = await processData(fName1, fNameN, "");
    */


    //      const ajgraphZ000 = jGraph(fName1000, fName2000, window.JmolAppletA000, "plJg000", fName3000, window.parallelCoord000);
    // import { makeGraphic } from "../src/nmrSpectrum.js";
    import { initializeSettings } from "../src/nmrSpectrum.js";
    import { createSVG } from "../src/nmrSpectrum.js";
    import { NmrSpectrum } from "../src/nmrSpectrum.js";

    import { NmrAssignment } from "../src/nmrAssignement.js";

    import { JgraphObject } from "../src/nmrSpectrumObject.js";

    const response = await fetch(fName1);
    const dataSpectrum = await response.text();
    const jsonSpectrum = JSON.parse(dataSpectrum);
    /*
    const nmrJsonFileName_sha256Hex = crypto
            .createHash("sha256")
            .update(dataSpectrum, "utf8")
            .digest("hex");
    */
    const response2 = await fetch(fNameN);
    const jsonMolecule2 = await response2.text();
    const jsonMolecule = JSON.parse(jsonMolecule2);

    const origin = {
      timeStampConversion: "no timestamp for tests",
      nmrJsonFileName: fName1,
      //nmrJsonFile_sha256Hex: nmrJsonFile_sha256Hex,
      moleculeJsonFileName: fNameN,
      //	moleculeJsonFile_sha256Hex: moleculeJsonFile_sha256Hex,
    };

    const param = {
      creatorParam: {
        editor: "djeanner",
        version: "1",
        source: "MnovaJson",
        id: "none",
      },
    };

    const jGraph = new JgraphObject(param, {
      jsonSpectrum: jsonSpectrum,
      jsonMolecule: jsonMolecule,
      jsonDataInitial: {},
      origin: origin,
    });


    const settings = initializeSettings({});
    var svg = createSVG("my_dataviz", settings);
    var spectrum = new NmrSpectrum(
      jGraph.data.spectrumDataAllChopped,
      svg,
      settings,
      settings.smallScreen, // default true
      //{totalCoveredPPM: 7.0,regions: [{ start: 8.0, end: 1.0 }]},
      jGraph.data.regionsData // default {}
    );

    const settings_with_spectrum_settings = spectrum.getSettings();

    var nmrAssignmentList = [];
    var first = true;
    for (const jGraphObj of jGraph.data.jGraphObjDataList) {
      const condition = Array.isArray(jGraphObj) && first; if (condition) { first = false; } // first array only
      if (condition) {
        nmrAssignmentList.push(
          new NmrAssignment(
            jGraphObj,
            svg,
            settings_with_spectrum_settings.smallScreen,
            settings_with_spectrum_settings,
            JmolAppletAz,
            nmrAssignmentList.length
          )
        );
      }
    }

    const classes = [...nmrAssignmentList, spectrum];

    // Register each class as a receiver for every other class based on data type compatibility

    classes.forEach((sender) => {
      classes.forEach((receiver) => {
        if (sender !== receiver) {
          sender.getExportTypes().forEach((sendType) => {
            if (receiver.getImportTypes().includes(sendType)) {
              sender.registerReceiver(receiver, sendType);
            }
          });
        }
      });
    });
    spectrum.triggerSendAxis();
    nmrAssignmentList.forEach((nmrAssignment) => {
      nmrAssignment.build();
    });

  </script>
  Brush horizontally to zoom and double-click to restore the full spectrum.
  <h2>J Graph</h2>
  <p>The coupling constants are represented with dots (or blocks when assigned) on the vertical axes, given in Hz.</p>
  <p>Hover over the labels to highlight the relevant atom(s) on the 3D model.</p>
  <p>Hover over the dots/blocks to display the value of the coupling constant and dihedral angles with potential
    coupling partners.</p>
  <p>Double-click on the coupling to pair the coupling constants when the ruler is green, indicating that the coupling
    partner is unambiguous. Try, for example, with J(8a,7a).</p>

  <h4>Make your own assignement page from Mnova documents</h4>
  Use "Save as" in Mnova >=15.1 and select the relevant (*.json) entries or use Mnova scripting:
  <div class="code-box">
    <pre><code>
serialization.save("c:/santonin.mol", "mol"); // for JSmol
serialization.save("c:/santonin_molecule.json", "JSON Molecule (*.json)") // for the J-graph
serialization.save("c:/santonin_spectrum.json", "JSON NMR (*.json)") // for the spectrum
</code></pre>
  </div>
</body>

</html>