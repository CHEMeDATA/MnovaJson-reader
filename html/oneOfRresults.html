<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
	<h4>Mnova json demonstration page</h4>
	<p>This page reads the json serialization of Mnova document and uses JSmol and CHEMeDATA viewers for their
		visualization.</p>
	<style>
		.code-box {
			background: #f4f4f4;
			padding: 10px;
			font-family: monospace;
		}
	</style>

	<script type="text/javascript" src="src/JSmol.min.js"></script>
	<p id="textMainPage" style="height:20px">J-graph output</p>
	<script>

		var molec = "Vaniline_assigned";
		molec = "07-Papaverine_H"; // not working
		molec = "08-paper22"; // OK
		molec = "01_NOTassigned"; // OK
		molec = "adcb_anatolia_empty"; // OK
		molec = "02-AZ138"; // OK
		molec = "07-Papaverine"; // OK 
		molec = "phenanthrene_assigned"; // OK 
		molec = "di-buthyl-ether"; // OK 
		molec = "Ibuprofen_slow"; // OK 
		molec = "01_assigned"; // OK 

		compoundStructure = {

			script: "set antialiasDisplay true;load ../testSpinFit_assigned/" + molec + ".mol;cartoon on;color cartoon structure; rotate z 45.0;rotate x 80;",
			width: 350,
			height: 200,
			j2sPath: "src/j2s",
			disableJ2SLoadMonitor: false,
			isableInitialConsole: true
		}
		Jmol.getApplet("JmolAppletAz", compoundStructure);
	</script>

	<div id="my_dataviz"></div>

	<script type="module">
		var fName1 = "../testSpinFit_assigned/" + molec + "_Set.spectra.json";
		var fNameN = "../testSpinFit_assigned/" + molec + "_molecule.json"
		var fName3008 = "../testSpinFit_assigned/" + molec + "_Set.spinFitResult.json"
		
                    import { initializeSettings } from "../external/nmrSpectrum.js";
                    import { createSVG } from "../external/nmrSpectrum.js";
                    import { NmrSpectrum } from "../external/nmrSpectrum.js";

                    import { NmrAssignment } from "../src/nmrAssignement.js";
                    import { JgraphObject } from "../external/jGraphObject.js";

                    const response = await fetch(fName1);
                    const dataSpectrum = await response.text();
                    const jsonSpectrum = JSON.parse(dataSpectrum);

                    const response2 = await fetch(fNameN);
                    const jsonMolecule2 = await response2.text();
                    const jsonMolecule = JSON.parse(jsonMolecule2);

                    const response3 = await fetch(fName3008);
                    const jsonDataInitial2 = await response3.text();
                    const jsonDataInitial = JSON.parse(jsonDataInitial2);
                    const origin = {
                        timeStampConversion: "no timestamp for tests",
                        nmrJsonFileName: fName1,
                        //nmrJsonFile_sha256Hex: nmrJsonFile_sha256Hex,
                        moleculeJsonFileName: fNameN,
                        //	moleculeJsonFile_sha256Hex: moleculeJsonFile_sha256Hex,
                        parallelDataJsonFileName: fName3008,
                        //	parallelDataJsonFile_sha256Hex: parallelDataFileName_sha256Hex,
                    };
                    const param = {
                        creatorParam: {
                            editor: "djeanner",
                            version: "1",
                            source: "MnovaJson",
                            id: "none",
                        },
                    };

                    const jGraph = new JgraphObject(param, {
                        jsonSpectrum: jsonSpectrum,
                        jsonMolecule: jsonMolecule,
                        jsonDataInitial: jsonDataInitial,
                        origin: origin,
                    });

                    const settings = initializeSettings({});
                    var svg = createSVG("my_dataviz", settings);
                    var spectrum = new NmrSpectrum(
                        jGraph.data.spectrumDataAllChopped,
                        svg,
                        settings,
                        settings.smallScreen, // default true
                        //{totalCoveredPPM: 7.0,regions: [{ start: 8.0, end: 1.0 }]},
                        jGraph.data.regionsData // default {}
                    );

                    const settings_with_spectrum_settings = spectrum.getSettings();

                    var nmrAssignmentList = [];
                    var first = true;
                    for (const jGraphObj2 of jGraph.data.jGraphObjDataList) {

                        const condition1 = (jGraphObj2 && typeof jGraphObj2 === "object" && jGraphObj2.type === "couplingNetwork");
                        const condition2 = (jGraphObj2 && typeof jGraphObj2 === "object" && jGraphObj2.type === "variableSet");
                        const condition3 = Array.isArray(jGraphObj2) && first; if (condition3) { first = false; } // first array only
                        if (condition1 || condition2 || condition3) {
                            nmrAssignmentList.push(
                                new NmrAssignment(
                                    jGraphObj2,
                                    svg,
                                    settings_with_spectrum_settings.smallScreen,
                                    settings_with_spectrum_settings,
                                    "JmolAppletAz", /// HERE SHOULE BE VARIABLE set in html((((((((((((((((((((((((((((((()))))))))))))))))))))))))))))))re move quotes
                                    nmrAssignmentList.length
                                )
                            );
                        }
                    }

                    const classes = [...nmrAssignmentList, spectrum];
                  
                    // Register each class as a receiver for every other class based on data type compatibility


                    classes.forEach((sender) => {
                        classes.forEach((receiver) => {
                            if (sender !== receiver) {
                                sender.getExportTypes().forEach((sendType) => {
                                    if (receiver.getImportTypes().includes(sendType)) {
                                        sender.registerReceiver(receiver, sendType);
                                    }
                                });
                            }
                        });
                    });
                    spectrum.triggerSendAxis();
                    nmrAssignmentList.forEach((nmrAssignment) => {
                        nmrAssignment.build();
                    });


	</script>
	Brush horizontally to zoom and double-click to restore the full spectrum.
	<h2>J Graph</h2>
	<p>The coupling constants are represented with dots (or blocks when assigned) on the vertical axes, given in Hz.</p>
	<p>Hover over the labels to highlight the relevant atom(s) on the 3D model.</p>
	<p>Hover over the dots/blocks to display the value of the coupling constant and dihedral angles with potential
		coupling partners.</p>
	<p>Double-click on the coupling to pair the coupling constants when the ruler is green, indicating that the coupling
		partner is unambiguous.</p>

	<h4>Make your own assignement page from Mnova documents</h4>
	Use "Save as" in Mnova >=14.1 and select the relevant (*.json) entries or use Mnova scripting:
	<div class="code-box">
		<pre><code>
serialization.save("c:/FILENAME.mol", "mol"); // for JSmol
serialization.save("c:/FILENAME_molecule.json", "JSON Molecule (*.json)") // for the J-graph
serialization.save("c:/FILENAME_spectrum.json", "JSON NMR (*.json)") // for the spectrum
</code></pre>
	</div>
</body>

</html>